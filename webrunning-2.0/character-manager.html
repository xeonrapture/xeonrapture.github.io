<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Webrunning Characters</title>
  <link rel="stylesheet" href="/shared/site.css">

  <style>
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 0.5rem;
      border-bottom: 1px solid var(--border, #333);
      text-align: left;
      font-size: 0.9rem;
    }
    th { opacity: 0.8; }
    .actions { display: flex; gap: 0.25rem; }
    .mono { font-family: ui-monospace, monospace; }
  </style>
</head>

<body>
  <div id="nav"></div>

  <main class="wrap">
    <h1>Webrunning Characters</h1>

    <div style="margin-bottom:1rem;">
      <button id="newCharacterBtn">+ New Character</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Lvl</th>
          <th>HP</th>
          <th>XP</th>
          <th>Luck</th>
          <th>Ess</th>
          <th>P</th>
          <th>D</th>
          <th>S</th>
          <th>I</th>
          <th>Slots</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="charTable">
        <tr><td colspan="12">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </main>

  <!-- Rename modal -->
  <div id="nameModal" class="xr-modal hidden">
    <div class="xr-modal-backdrop"></div>
    <div class="xr-modal-card">
      <h2>Edit Character Name</h2>
      <input id="charNameInput" />
      <div class="xr-modal-actions">
        <button id="saveNameBtn">Save</button>
        <button id="cancelNameBtn">Cancel</button>
      </div>
      <div id="nameMsg" class="mono muted"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/shared/auth.js"></script>
  <script src="/shared/nav.js"></script>

  <script>
    const sb = window.supabaseClient;
    const table = document.getElementById("charTable");

    let characters = [];
    let activeCharId = null;
    let currentUser = null;

    async function requireUser() {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) {
        table.innerHTML = "<tr><td colspan='12'>Not logged in.</td></tr>";
        throw new Error("No user");
      }
      return user;
    }

    async function loadCharacters() {
      try {
        currentUser = await requireUser();

        const { data, error } = await sb
          .from("webrunning.characters")
          .select("id, name, base_stats")
          .eq("user_id", currentUser.id)
          .order("created_at", { ascending: true });

        if (error) throw error;

        characters = data;
        render();
      } catch (e) {
        console.error("Load failed:", e);
        table.innerHTML = "<tr><td colspan='12'>Failed to load.</td></tr>";
      }
    }

    function s(c, key) {
      return c.base_stats?.[key] ?? 0;
    }

    function render() {
      if (!characters.length) {
        table.innerHTML = "<tr><td colspan='12'>No characters yet.</td></tr>";
        return;
      }

      table.innerHTML = "";
      for (const c of characters) {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${c.name}</td>
          <td>${s(c,"level")}</td>
          <td>${s(c,"hp")}</td>
          <td>${s(c,"xp")}</td>
          <td>${s(c,"luck")}</td>
          <td>${s(c,"essence")}</td>
          <td>${s(c,"power")}</td>
          <td>${s(c,"defense")}</td>
          <td>${s(c,"speed")}</td>
          <td>${s(c,"intelligence")}</td>
          <td>${s(c,"inventory_slots")}</td>
          <td class="actions">
            <button onclick="editName('${c.id}')">‚úèÔ∏è</button>
            <button onclick="deleteChar('${c.id}')">üóëÔ∏è</button>
          </td>
        `;
        table.appendChild(row);
      }
    }

    // ===== Rename =====
    const modal = document.getElementById("nameModal");
    const nameInput = document.getElementById("charNameInput");
    const nameMsg = document.getElementById("nameMsg");

    window.editName = (id) => {
      activeCharId = id;
      const c = characters.find(x => x.id === id);
      nameInput.value = c.name;
      modal.classList.remove("hidden");
    };

    document.getElementById("cancelNameBtn").onclick =
      () => modal.classList.add("hidden");

    document.getElementById("saveNameBtn").onclick = async () => {
      const name = nameInput.value.trim();
      if (!name) return;

      const { error } = await sb
        .from("webrunning.characters")
        .update({ name })
        .eq("id", activeCharId)
        .eq("user_id", currentUser.id);

      if (error) {
        console.error(error);
        nameMsg.textContent = error.message;
        return;
      }

      modal.classList.add("hidden");
      loadCharacters();
    };

    // ===== Delete =====
    window.deleteChar = async (id) => {
      if (!confirm("Delete this character?")) return;

      const { error } = await sb
        .from("webrunning.characters")
        .delete()
        .eq("id", id)
        .eq("user_id", currentUser.id);

      if (error) {
        console.error(error);
        return;
      }

      loadCharacters();
    };

    // ===== Create =====
    document.getElementById("newCharacterBtn").onclick = async () => {
      const name = prompt("Character name?");
      if (!name) return;

      try {
        currentUser = await requireUser();

        const { error } = await sb
          .from("webrunning.characters")
          .insert({
            user_id: currentUser.id,
            name,
            base_stats: {
              hp: 10,
              level: 1,
              xp: 0,
              luck: 0,
              essence: 0,
              power: 0,
              defense: 0,
              speed: 0,
              intelligence: 0,
              inventory_slots: 5
            }
          });

        if (error) throw error;

        loadCharacters();
      } catch (e) {
        console.error("Create failed:", e);
        alert(e.message);
      }
    };

    loadCharacters();
  </script>

</body>
</html>
