<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Webrunning Characters</title>
  <link rel="stylesheet" href="/shared/style.css">
</head>

<body class="wr-scope">
  <div id="nav"></div>

  <main class="wrap">
    <h1>Webrunning Characters</h1>

    <div class="character-actions">
      <button id="newCharacterBtn">+ New Character</button>
    </div>

    <table class="table-full">
      <thead>
        <tr>
          <th>Name</th>
          <th>Lvl</th>
          <th>HP</th>
          <th>XP</th>
          <th>Luck</th>
          <th>Ess</th>
          <th>P</th>
          <th>D</th>
          <th>S</th>
          <th>I</th>
          <th>Slots</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="charTable">
        <tr><td colspan="12">Loading‚Ä¶</td></tr>
      </tbody>
    </table>
  </main>

  <!-- Create / Rename modal -->
  <div id="charModal" class="xr-modal hidden">
    <div class="xr-modal-backdrop"></div>

    <div class="xr-modal-card">
      <h2 id="charModalTitle">Character</h2>

      <input
        id="charNameInput"
        type="text"
        maxlength="32"
        placeholder="Character name"
        autocomplete="off"
      />

      <div class="modal-section">
        <strong>Allocate 3 Basic Stat Points</strong>
        <div class="stat-inputs">
          <label>Power
            <input id="startPower" type="number" min="0" value="0" />
          </label>
          <label>Defense
            <input id="startDefense" type="number" min="0" value="0" />
          </label>
          <label>Speed
            <input id="startSpeed" type="number" min="0" value="0" />
          </label>
          <label>Intelligence
            <input id="startIntelligence" type="number" min="0" value="0" />
          </label>
        </div>
        <p class="muted">Points remaining: <span id="startPointsRemaining">3</span></p>
      </div>

      <div class="modal-section">
        <strong>Starting Gear Appearance</strong>
        <div class="starting-gear-grid">
          <label>Head Item
            <select id="startHeadItem"></select>
          </label>
          <label>Torso Item
            <select id="startTorsoItem"></select>
          </label>
          <label>Rings Item
            <select id="startRingItem"></select>
          </label>
          <label>Legs Item
            <select id="startLegsItem"></select>
          </label>
          <label>One-Handed Weapon
            <select id="startWeaponItem"></select>
          </label>
        </div>
        <p class="muted">These basics start equipped at level 1.</p>
      </div>

      <div class="xr-modal-actions">
        <button id="charSaveBtn">Save</button>
        <button id="charCancelBtn">Cancel</button>
      </div>

      <div id="charModalMsg" class="mono muted">&nbsp;</div>
    </div>
  </div>

  <!-- Delete modal -->
  <div id="deleteModal" class="xr-modal hidden">
    <div class="xr-modal-backdrop"></div>

    <div class="xr-modal-card">
      <h2>Delete Character</h2>
      <p id="deletePrompt" class="muted"></p>

      <div class="xr-modal-actions">
        <button id="confirmDeleteBtn">Delete</button>
        <button id="cancelDeleteBtn">Cancel</button>
      </div>

      <div id="deleteModalMsg" class="mono muted">&nbsp;</div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/shared/auth.js"></script>
  <script src="/shared/nav.js"></script>

  <script>
    const sb = window.supabaseClient;
    const table = document.getElementById("charTable");

    let characters = [];
    let activeCharId = null;
    let currentUser = null;

    async function requireUser() {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) {
        table.innerHTML = "<tr><td colspan='12'>Not logged in.</td></tr>";
        throw new Error("No user");
      }
      return user;
    }

    async function loadCharacters() {
      try {
        currentUser = await requireUser();

        const { data, error } = await sb
          .from("webrunning_characters")
          .select("id, name, base_stats")
          .eq("user_id", currentUser.id)
          .order("created_at", { ascending: true });

        if (error) throw error;

        characters = data;
        render();
      } catch (e) {
        console.error("Load failed:", e);
        table.innerHTML = "<tr><td colspan='12'>Failed to load.</td></tr>";
      }
    }

    function s(c, key) {
      return c.base_stats?.[key] ?? 0;
    }

    function render() {
      if (!characters.length) {
        table.innerHTML = "<tr><td colspan='12'>No characters yet.</td></tr>";
        return;
      }

      table.innerHTML = "";
      for (const c of characters) {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${c.name}</td>
          <td>${s(c,"level")}</td>
          <td>${s(c,"hp")}</td>
          <td>${s(c,"xp")}</td>
          <td>${s(c,"luck")}</td>
          <td>${s(c,"essence")}</td>
          <td>${s(c,"power")}</td>
          <td>${s(c,"defense")}</td>
          <td>${s(c,"speed")}</td>
          <td>${s(c,"intelligence")}</td>
          <td>${s(c,"inventory_slots")}</td>
          <td class="actions">
            <a class="action-btn" href="/webrunning-2.0/webrunning-character.html?id=${c.id}" title="Edit">‚úèÔ∏è</a>
            <button class="action-btn" onclick="openDeleteModal('${c.id}')">üóëÔ∏è</button>
          </td>
        `;
        table.appendChild(row);
      }
    }

    // ===== Unified Create / Rename modal =====
    const modal = document.getElementById("charModal");
    const modalTitle = document.getElementById("charModalTitle");
    const nameInput = document.getElementById("charNameInput");
    const modalMsg = document.getElementById("charModalMsg");
    const saveBtn = document.getElementById("charSaveBtn");
    const cancelBtn = document.getElementById("charCancelBtn");
    const startPower = document.getElementById("startPower");
    const startDefense = document.getElementById("startDefense");
    const startSpeed = document.getElementById("startSpeed");
    const startIntelligence = document.getElementById("startIntelligence");
    const startPointsRemaining = document.getElementById("startPointsRemaining");
    const startHeadItem = document.getElementById("startHeadItem");
    const startTorsoItem = document.getElementById("startTorsoItem");
    const startRingItem = document.getElementById("startRingItem");
    const startLegsItem = document.getElementById("startLegsItem");
    const startWeaponItem = document.getElementById("startWeaponItem");

    let modalMode = null; // "create" | "rename"

    const clothingGearTable = {
      Head: ["Hat", "Helmet", "Headband", "Diadem", "Facemask", "Goggles", "Earrings or Other Piercings", "Glasses or Shades"],
      Torso: ["Cloak + Tunic", "T-Shirt", "Longsleeve Shirt", "Hoodie", "Armor", "Shirt + Cape", "Dress", "Jumpsuit"],
      Legs: ["Pants", "Shorts", "Greaves", "Baggy", "Skirt", "Kilt"],
      Ring: ["Large Gem", "Small Band", "Thick Band", "Small Gem"]
    };

    const oneHandedWeaponOptions = [
      "Dagger",
      "Morningstar",
      "Shortsword",
      "Katar",
      "Rapier",
      "Scimitar",
      "Katana",
      "Machete",
      "Handaxe",
      "Flail",
      "Pickaxe",
      "Whip",
      "Buckler Shield",
      "Mace",
      "Hammer",
      "Club",
      "Shillelagh",
      "Gauntlet",
      "Pistol",
      "Crossbow",
      "Boomerang",
      "Snowball",
      "Shuriken",
      "Throwing Knife",
      "Javelin",
      "Rock",
      "Uzi Gun",
      "Coin",
      "Sling",
      "Atlatl",
      "Wand",
      "Orb",
      "Totem",
      "Crystal",
      "Rod",
      "Lantern",
      "Ice Cube",
      "Pineapple",
      "Bomb",
      "Lightning Javelin",
      "Mirror",
      "Bell"
    ];

    function populateSelectOptions(select, options) {
      if (!select) return;
      select.innerHTML = "";
      options.forEach(option => {
        const el = document.createElement("option");
        el.value = option;
        el.textContent = option;
        select.appendChild(el);
      });
    }

    function updateStartPointsRemaining() {
      const allocated = (Number(startPower.value) || 0)
        + (Number(startDefense.value) || 0)
        + (Number(startSpeed.value) || 0)
        + (Number(startIntelligence.value) || 0);
      const remaining = Math.max(3 - allocated, 0);
      if (startPointsRemaining) {
        startPointsRemaining.textContent = String(remaining);
      }
    }

    function populateStartingGearOptions() {
      populateSelectOptions(startHeadItem, clothingGearTable.Head);
      populateSelectOptions(startTorsoItem, clothingGearTable.Torso);
      populateSelectOptions(startRingItem, clothingGearTable.Ring);
      populateSelectOptions(startLegsItem, clothingGearTable.Legs);
      populateSelectOptions(startWeaponItem, oneHandedWeaponOptions);
    }

    function toggleCreateOnlyFields(show) {
      document.querySelectorAll(".modal-section").forEach(section => {
        section.style.display = show ? "grid" : "none";
      });
    }

    function openCreateModal() {
      modalMode = "create";
      modalTitle.textContent = "New Character";
      nameInput.value = "";
      modalMsg.textContent = "";
      toggleCreateOnlyFields(true);
      startPower.value = 0;
      startDefense.value = 0;
      startSpeed.value = 0;
      startIntelligence.value = 0;
      updateStartPointsRemaining();
      populateStartingGearOptions();
      modal.classList.remove("hidden");
      nameInput.focus();
    }

    function openRenameModal(id) {
      modalMode = "rename";
      activeCharId = id;
      const c = characters.find(x => x.id === id);
      modalTitle.textContent = "Rename Character";
      nameInput.value = c.name;
      modalMsg.textContent = "";
      toggleCreateOnlyFields(false);
      modal.classList.remove("hidden");
    }

    function closeModal() {
      modal.classList.add("hidden");
    }

    document.querySelector(".xr-modal-backdrop").onclick = closeModal;
    cancelBtn.onclick = closeModal;
    [startPower, startDefense, startSpeed, startIntelligence].forEach(input => {
      input.addEventListener("input", updateStartPointsRemaining);
    });

    function formatSignedValue(value) {
      return `${value >= 0 ? "+" : ""}${value}`;
    }

    function buildStat(name, value) {
      return {
        name,
        label: name,
        formula: formatSignedValue(value),
        value
      };
    }

    function formatStartingGearName({ rarity, color, color2, item_type, gear_type }) {
      const colors = [color, color2].filter(Boolean).join("/");
      const colorLabel = colors ? `${colors} ` : "";
      return `${rarity} ${colorLabel}${item_type || gear_type}`.trim();
    }

    function buildStartingGearPayloads() {
      const aesthetic = "Basic (just simple and plain)";
      const basePayload = {
        rarity: "Basic",
        color2: null,
        essence_value: 500,
        credit_value: 50,
        abilities: [],
        stat_modifiers: [],
        aesthetic
      };
      const payloads = [
        {
          ...basePayload,
          gear_type: "Head",
          color: "Gray",
          item_type: startHeadItem.value,
          stats: [buildStat("Perception", 1), buildStat("Hacking", 1)]
        },
        {
          ...basePayload,
          gear_type: "Torso",
          color: "Blue",
          item_type: startTorsoItem.value,
          stats: [buildStat("Armor", 1), buildStat("Defense DC", 1)]
        },
        {
          ...basePayload,
          gear_type: "Ring",
          color: "Neutral",
          item_type: startRingItem.value,
          stats: [buildStat("HP", 2), buildStat("Inventory Slots", 2)]
        },
        {
          ...basePayload,
          gear_type: "Legs",
          color: "Green",
          item_type: startLegsItem.value,
          stats: [buildStat("Initiative", 1), buildStat("Movement Speed", 2)]
        },
        {
          ...basePayload,
          gear_type: "One-Handed Weapon",
          color: "Neutral",
          item_type: startWeaponItem.value,
          stats: [buildStat("Attack Plus", 1), buildStat("Damage Plus", 1)]
        }
      ];
      payloads.forEach(payload => {
        payload.name = formatStartingGearName(payload);
      });
      return payloads;
    }

    async function createStartingGear(characterId) {
      const payloads = buildStartingGearPayloads();
      const { data: gearRows, error: gearError } = await sb
        .from("webrunning_gear")
        .insert(payloads)
        .select("id");
      if (gearError) throw gearError;
      if (!gearRows || !gearRows.length) return;
      const slots = ["head", "torso", "ring_1", "legs", "weapon_1"];
      const linkPayload = gearRows.map((row, index) => ({
        character_id: characterId,
        gear_id: row.id,
        equipped: true,
        gear_slot: slots[index]
      }));
      const { error: linkError } = await sb
        .from("webrunning_character_gear")
        .insert(linkPayload);
      if (linkError) throw linkError;
    }

    // Save handler
    saveBtn.onclick = async () => {
      const name = nameInput.value.trim();

      if (!name) {
        modalMsg.textContent = "Name cannot be empty.";
        return;
      }

      if (!/^[a-zA-Z0-9 _-]+$/.test(name)) {
        modalMsg.textContent = "Invalid characters.";
        return;
      }

      try {
        if (modalMode === "create") {
          const allocatedPoints = (Number(startPower.value) || 0)
            + (Number(startDefense.value) || 0)
            + (Number(startSpeed.value) || 0)
            + (Number(startIntelligence.value) || 0);
          if (allocatedPoints !== 3) {
            modalMsg.textContent = "Allocate exactly 3 stat points before saving.";
            return;
          }
          const { data, error } = await sb
            .from("webrunning_characters")
            .insert({
              user_id: currentUser.id,
              name,
                base_stats: {
                  hp: 5,
                  current_hp: 5,
                  level: 1,
                  xp: 0,
                  luck: 1,
                  essence: 0,
                  power: Number(startPower.value) || 0,
                  defense: Number(startDefense.value) || 0,
                  speed: Number(startSpeed.value) || 0,
                  intelligence: Number(startIntelligence.value) || 0,
                  inventory_slots: 10,
                  kernel_slots: 1,
                  energy_cap: 5,
                  energy_red: 0,
                  energy_blue: 0,
                  energy_gray: 0,
                  energy_green: 0
                }
            })
            .select("id")
            .maybeSingle();

          if (error) throw error;
          if (data?.id) {
            await createStartingGear(data.id);
          }
        }

        if (modalMode === "rename") {
          const { error } = await sb
            .from("webrunning_characters")
            .update({ name })
            .eq("id", activeCharId)
            .eq("user_id", currentUser.id);

          if (error) throw error;
        }

        closeModal();
        loadCharacters();
      } catch (e) {
        console.error(e);
        modalMsg.textContent = e.message;
      }
    };

    const deleteModal = document.getElementById("deleteModal");
    const deletePrompt = document.getElementById("deletePrompt");
    const deleteModalMsg = document.getElementById("deleteModalMsg");
    const confirmDeleteBtn = document.getElementById("confirmDeleteBtn");
    const cancelDeleteBtn = document.getElementById("cancelDeleteBtn");
    let deleteTargetId = null;

    function openDeleteModal(id) {
      deleteTargetId = id;
      const c = characters.find(x => x.id === id);
      deletePrompt.textContent = `Delete ${c?.name ?? "this character"}? This cannot be undone.`;
      deleteModalMsg.textContent = "";
      deleteModal.classList.remove("hidden");
    }

    function closeDeleteModal() {
      deleteModal.classList.add("hidden");
      deleteTargetId = null;
    }

    deleteModal.querySelector(".xr-modal-backdrop").onclick = closeDeleteModal;
    cancelDeleteBtn.onclick = closeDeleteModal;

    confirmDeleteBtn.onclick = async () => {
      if (!deleteTargetId) return;

      try {
        if (!currentUser) {
          currentUser = await requireUser();
        }

        const { error } = await sb
          .from("webrunning_characters")
          .delete()
          .eq("id", deleteTargetId)
          .eq("user_id", currentUser.id);

        if (error) throw error;

        characters = characters.filter(c => c.id !== deleteTargetId);
        render();
        closeDeleteModal();
      } catch (e) {
        console.error(e);
        deleteModalMsg.textContent = `Failed to delete: ${e.message}`;
      }
    };


    document.getElementById("newCharacterBtn").onclick = openCreateModal;
    window.addEventListener("DOMContentLoaded", () => {
      loadCharacters();
    });

  </script>

</body>
</html>
