<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XR Belief Roller (d8)</title>

  <link rel="stylesheet" href="/shared/style.css">
</head>

<body class="tools-scope">
  <div id="nav"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="/shared/auth.js"></script>
<script src="/shared/nav.js"></script>



  <main class="wrap">
    <h1>Belief Roller (d8)</h1>
    <p class="muted">Roll Nd8. Outputs: <b>Belief</b> (with Doubt subtracted) and <b>Experience</b> (same, but Doubt does not subtract).</p>

    <div class="card">
      <div class="row row-compact">
        <label for="dice">Dice to roll</label>
        <input id="dice" type="number" min="1" step="1" value="10" />
      </div>

      <div class="row row-compact">
        <label for="belief">Resulting Belief</label>
        <input id="belief" class="mono" type="text" readonly value="—" />
      </div>

      <div class="row row-compact">
        <label for="xp">Experience Output</label>
        <input id="xp" class="mono" type="text" readonly value="—" />
      </div>

      <div class="actions">
        <button id="rollBtn" aria-label="Roll" title="Roll"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><rect x="5" y="5" width="14" height="14" rx="2"></rect><circle cx="9" cy="9" r="1"></circle><circle cx="15" cy="15" r="1"></circle><circle cx="12" cy="12" r="1"></circle></svg><span>Roll</span></button>
        <button id="clearBtn" aria-label="Clear" title="Clear"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M14 4l6 6"></path><path d="M10 8l6 6"></path><path d="M4 20l9-9"></path><path d="M3 21h7"></path></svg><span>Clear</span></button>
      </div>

      <div class="table-wrap">
        <table>
          <colgroup>
            <col class="col-roll">
            <col class="col-meaning">
            <col class="col-belief">
            <col class="col-count">
            <col class="col-results">
          </colgroup>
          <thead>
            <tr>
              <th>Roll</th>
              <th>Meaning</th>
              <th>Belief</th>
              <th>Count</th>
              <th>Results</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="mono">1</td>
              <td>Doubt</td>
              <td class="mono bad">-1</td>
              <td class="mono" id="c1">0</td>
              <td class="mono" id="resc1">0</td>
            </tr>
            <tr>
              <td class="mono">2–4</td>
              <td>Expectation</td>
              <td class="mono">0</td>
              <td class="mono" id="c25">0</td>
              <td class="mono" id="resc25">0</td>
            </tr>
            <tr>
              <td class="mono">5–7</td>
              <td>Hope</td>
              <td class="mono">+1</td>
              <td class="mono" id="c67">0</td>
              <td class="mono" id="resc67">0</td>
            </tr>
            <tr>
              <td class="mono">8</td>
              <td>Confidence</td>
              <td class="mono">+2</td>
              <td class="mono" id="c8">0</td>
              <td class="mono" id="resc8">0</td>
            </tr>
          </tbody>
        </table>
      </div>

      <details class="details-block">
        <summary>Show individual rolls</summary>
        <div class="mono muted details-output" id="rollList">—</div>
      </details>

      <hr class="divider">

      <h3>Recent Rolls</h3>
      <div id="history" class="mono muted">
        <div class="muted">No rolls yet.</div>
      </div>

    </div>
  </main>

  <script>
    const el = (id) => document.getElementById(id);

    const history = [];
    const MAX_HISTORY = 10;
    
    function addToHistory(res) {
      history.unshift(res);
      if (history.length > MAX_HISTORY) history.pop();
      renderHistory();
    }
    
    function renderHistory() {
      const host = el("history");
      host.innerHTML = "";
    
      if (history.length === 0) {
        host.innerHTML = `<div class="muted">No rolls yet.</div>`;
        return;
      }
    
      history.forEach((h, idx) => {
        const div = document.createElement("div");
        div.className = "inline";
        div.style.marginBottom = "0.25rem";
    
        div.innerHTML = `
          <span>${h.n}d8 → <b>${h.belief}</b> (XP ${h.xp})</span>
          <button data-i="${idx}" aria-label="Reroll" title="Reroll"><svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M20 7h-6a5 5 0 0 0-5 5"></path><path d="M4 17h6a5 5 0 0 0 5-5"></path><path d="M17 4l3 3-3 3"></path><path d="M7 14l-3 3 3 3"></path></svg><span>Reroll</span></button>
        `;
    
        div.querySelector("button").addEventListener("click", () => {
          const r = rollOnce(h.n);
          renderSingle(r);
          addToHistory(r);
        });
    
        host.appendChild(div);
      });
    }


    function randInt(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    // Belief includes Doubt subtraction
    function beliefDelta(r) {
      if (r === 1) return -1;
      if (r >= 2 && r <= 4) return 0;
      if (r === 5 || r === 7) return 1;
      return 2; // 8
    }

    // XP ignores Doubt subtraction (Doubt contributes 0)
    function xpDelta(r) {
      if (r === 1) return 0;
      if (r >= 2 && r <= 4) return 0;
      if (r === 5 || r === 7) return 1;
      return 2; // 8
    }

    function rollOnce(n) {
      n = Number(n);
      if (!Number.isFinite(n) || n < 1) throw new Error("Dice must be 1 or more.");

      let belief = 0;
      let xp = 0;

      let c1 = 0, c25 = 0, c67 = 0, c8 = 0;
      const rolls = [];

      for (let i = 0; i < n; i++) {
        const r = randInt(1, 8);
        rolls.push(r);

        belief += beliefDelta(r);
        xp += xpDelta(r);

        if (r === 1) c1++;
        else if (r >= 2 && r <= 4) c25++;
        else if (r === 5 || r === 7) c67++;
        else c8++;
      }

      return { n, belief, xp, c1, c25, c67, c8, rolls };
    }

    function renderCounts(c1, c25, c67, c8) {
      el("c1").textContent = c1;
      el("c25").textContent = c25;
      el("c67").textContent = c67;
      el("c8").textContent = c8;
    }

    function renderResults(resc1, resc25, resc67, resc8) {
      el("resc1").textContent = resc1;
      el("resc25").textContent = resc25;
      el("resc67").textContent = resc67;
      el("resc8").textContent = resc8;
    }

    function renderSingle(res) {
      el("belief").value = String(res.belief);
      el("xp").value = String(res.xp);
      const resc1 = "-" + res.c1
      const resc25 = res.c25 * 0
      const resc67 = "+" + res.c67
      const resc8 = "+" + (res.c8 * 2)
      renderCounts(res.c1, res.c25, res.c67, res.c8);
      renderResults(resc1, resc25, resc67, resc8);
      el("rollList").textContent = res.rolls.join(", ");
    }

    function renderAverage(n, trials, avgBelief, avgXP, avgC1, avgC25, avgC67, avgC8) {
      el("belief").value = avgBelief.toFixed(2);
      el("xp").value = avgXP.toFixed(2);
      const resc1 = "-" + avgC1
      const resc25 = avgC25 * 0
      const resc67 = "+" + avgC67
      const resc8 = "+" + (avgC8 * 2)
      renderCounts(avgC1.toFixed(2), avgC25.toFixed(2), avgC67.toFixed(2), avgC8.toFixed(2));
      renderResults(resc1, resc25, resc67, resc8);
      el("rollList").textContent = `Averaged over ${trials} trials (no single roll list).`;
    }

    function clearAll() {
      el("belief").value = "—";
      el("xp").value = "—";
      renderCounts("0","0","0","0");
      renderResults("0","0","0","0");
      el("rollList").textContent = "—";
    }


    el("rollBtn").addEventListener("click", () => {
      try {
        const res = rollOnce(el("dice").value);
        renderSingle(res);
        addToHistory(res);
      } catch (e) {
        el("belief").value = "ERR";
        el("xp").value = "ERR";
        el("rollList").textContent = `Error: ${e.message || String(e)}`;
      }
    });


    el("clearBtn").addEventListener("click", clearAll);

    el("dice").addEventListener("keydown", (e) => {
      if (e.key === "Enter") el("rollBtn").click();
    });
  </script>
</body>
</html>

