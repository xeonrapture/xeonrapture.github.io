<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>XR Campaigns</title>
  <link rel="stylesheet" href="/shared/style.css">
  <style>
    .campaign-top-grid { display:grid; gap:1rem; grid-template-columns:1fr; }
    @media (min-width: 980px) { .campaign-top-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); align-items:start; } }
  </style>
</head>
<body class="wr-scope">
  <div id="nav"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/shared/auth.js"></script>
  <script src="/shared/nav.js"></script>

  <main class="wrap">
    <h1>Campaigns</h1>
    <p class="muted">Campaigns are now system-specific. A campaign can be Webrunning or XRRPG, and assigned characters must match.</p>

    <div class="campaign-top-grid wr-mt-1">
      <section class="card">
        <h2>Create Campaign</h2>
        <label>Campaign name
          <input id="newCampaignName" type="text" maxlength="80" placeholder="Weekend Run" />
        </label>
        <label>System
          <select id="newCampaignSystem">
            <option value="webrunning">Webrunning</option>
            <option value="xrrpg">XRRPG</option>
          </select>
        </label>
        <button id="createCampaignBtn" type="button">Create Campaign</button>
      </section>

      <section class="card">
        <h2>Your Campaigns</h2>
        <select id="gameSelect"></select>
        <div id="gameStatus" class="mono muted wr-mt-0-5"></div>
      </section>

      <section id="gmControls" class="card hidden">
        <h2>Invite a Player</h2>
        <label>Invite player from friends list
          <select id="inviteFriendSelect"><option value="">-- Select friend --</option></select>
        </label>
        <button id="invitePlayerBtn" type="button">Invite to Campaign</button>
      </section>
    </div>

    <section class="card wr-mt-1">
      <h2>Players</h2>
      <div id="memberList" class="mono muted">Loading members...</div>
    </section>

    <section class="card wr-mt-1">
      <h2>Assigned Characters (Read-only)</h2>
      <div id="characterList" class="assigned-character-list muted">No characters assigned yet.</div>
    </section>

    <section id="playerCharacterControls" class="card wr-mt-1 hidden">
      <h2>Your Character for this Campaign</h2>
      <p id="playerSystemHint" class="muted"></p>
      <label>Character
        <select id="playerCharacterSelect"></select>
      </label>
      <button id="savePlayerCharacterBtn" type="button">Save Character Selection</button>
      <div id="playerCharacterStatus" class="mono muted wr-mt-0-5"></div>
    </section>
  </main>

  <script>
    const sb = window.supabaseClient;
    const gameSelect = document.getElementById("gameSelect");
    const gameStatus = document.getElementById("gameStatus");
    const createCampaignBtn = document.getElementById("createCampaignBtn");
    const newCampaignName = document.getElementById("newCampaignName");
    const newCampaignSystem = document.getElementById("newCampaignSystem");
    const memberList = document.getElementById("memberList");
    const characterList = document.getElementById("characterList");
    const gmControls = document.getElementById("gmControls");
    const playerCharacterControls = document.getElementById("playerCharacterControls");
    const playerCharacterSelect = document.getElementById("playerCharacterSelect");
    const savePlayerCharacterBtn = document.getElementById("savePlayerCharacterBtn");
    const playerCharacterStatus = document.getElementById("playerCharacterStatus");
    const playerSystemHint = document.getElementById("playerSystemHint");
    const invitePlayerBtn = document.getElementById("invitePlayerBtn");
    const inviteFriendSelect = document.getElementById("inviteFriendSelect");

    let currentUser = null;
    let memberships = [];
    let playerCharacters = [];
    let friends = [];

    async function requireUser() {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) {
        window.location.href = "/login.html";
        throw new Error("No user");
      }
      return user;
    }

    function selectedGameId() { return gameSelect.value || null; }
    function selectedMembership() { return memberships.find(m => String(m.campaign_id) === String(selectedGameId())); }
    function selectedCampaignSystem() { return selectedMembership()?.campaigns?.system || 'webrunning'; }

    async function loadGames() {
      currentUser = await requireUser();
      const { data, error } = await sb
        .from("campaign_members")
        .select("campaign_id, role, campaigns(id, name, gm_user_id, system)")
        .eq("user_id", currentUser.id)
        .order("joined_at", { ascending: true });

      if (error) {
        gameStatus.textContent = `Failed to load campaigns: ${error.message}`;
        return;
      }

      memberships = data || [];
      gameSelect.innerHTML = "";
      if (!memberships.length) {
        gameSelect.innerHTML = "<option value=''>No campaigns yet</option>";
        gameStatus.textContent = "Accept a campaign invite from Notifications to join.";
        memberList.textContent = "No game selected.";
        characterList.textContent = "No game selected.";
        playerCharacterControls.classList.add("hidden");
        return;
      }

      memberships.forEach(m => {
        const option = document.createElement("option");
        option.value = m.campaign_id;
        const systemLabel = (m.campaigns?.system || 'webrunning').toUpperCase();
        option.textContent = `${m.campaigns?.name || "Unnamed Campaign"} [${systemLabel}] (${m.role.toUpperCase()})`;
        gameSelect.appendChild(option);
      });

      await loadGameDetails();
    }

    async function loadFriendInviteOptions() {
      currentUser = currentUser || await requireUser();
      const { data, error } = await sb
        .from("friendships")
        .select("user_a, user_b, created_at")
        .or(`user_a.eq.${currentUser.id},user_b.eq.${currentUser.id}`)
        .order("created_at", { ascending: false });

      inviteFriendSelect.innerHTML = "<option value=''>-- Select friend --</option>";
      if (error) return;

      const friendIds = (data || []).map(row => row.user_a === currentUser.id ? row.user_b : row.user_a);
      if (!friendIds.length) return;

      const { data: profiles } = await sb.from("profile_directory").select("id, username").in("id", friendIds);
      const byId = Object.fromEntries((profiles || []).map(profile => [profile.id, profile]));
      friends = friendIds.map(id => byId[id]).filter(Boolean);

      friends.forEach(friend => {
        const option = document.createElement("option");
        option.value = friend.id;
        option.textContent = friend.username || friend.id;
        inviteFriendSelect.appendChild(option);
      });
    }

    function assignmentCharacterId(row) {
      return row.character_system === 'xrrpg' ? row.xrrpg_character_id : row.webrunning_character_id;
    }

    function xrrpgStatBlurb(baseStats = {}) {
      return `Lv ${baseStats.level || 1} • Vig ${baseStats.vigor || 0} End ${baseStats.endurance || 0} Intu ${baseStats.intuition || 0} Wit ${baseStats.wit || 0}`;
    }

    async function loadGameDetails() {
      const campaignId = selectedGameId();
      if (!campaignId) return;
      const membership = selectedMembership();
      const system = selectedCampaignSystem();
      const isGm = membership?.role === "gm";
      const isPlayer = membership?.role === "player";

      gmControls.classList.toggle("hidden", !isGm);
      playerCharacterControls.classList.toggle("hidden", !isPlayer);
      playerSystemHint.textContent = `This campaign uses ${system.toUpperCase()} characters.`;
      gameStatus.textContent = `${isGm ? 'You are the GM' : 'You are a player'} for this ${system.toUpperCase()} game.`;

      if (isPlayer) await loadPlayerCharacterOptions(campaignId, system);

      const { data: members, error: membersError } = await sb
        .from("campaign_members")
        .select("user_id, role")
        .eq("campaign_id", campaignId)
        .order("joined_at", { ascending: true });

      if (membersError) {
        memberList.textContent = `Failed to load players: ${membersError.message}`;
      } else {
        const ids = (members || []).map(m => m.user_id);
        const { data: profiles } = ids.length
          ? await sb.from("profile_directory").select("id, username").in("id", ids)
          : { data: [] };
        const byId = Object.fromEntries((profiles || []).map(p => [p.id, p.username || "(no username)"]));
        memberList.innerHTML = (members || []).map(m => `<div>• ${byId[m.user_id] || m.user_id} — ${m.role === 'gm' ? 'GM' : 'Player'}</div>`).join('') || 'No members yet.';
      }

      const { data: assignments, error: assignmentError } = await sb
        .from("campaign_character_assignments")
        .select("user_id, character_system, webrunning_character_id, xrrpg_character_id")
        .eq("campaign_id", campaignId)
        .order("assigned_at", { ascending: true });

      if (assignmentError) {
        characterList.textContent = `Failed to load characters: ${assignmentError.message}`;
        return;
      }
      if (!(assignments || []).length) {
        characterList.textContent = "No characters assigned to this game yet.";
        return;
      }

      const webrunningIds = assignments.filter(row => row.character_system === 'webrunning' && row.webrunning_character_id).map(row => row.webrunning_character_id);
      const xrrpgIds = assignments.filter(row => row.character_system === 'xrrpg' && row.xrrpg_character_id).map(row => row.xrrpg_character_id);
      const [{ data: webrunningChars = [] }, { data: xrrpgChars = [] }] = await Promise.all([
        webrunningIds.length ? sb.from('webrunning_characters').select('id, name').in('id', webrunningIds) : Promise.resolve({ data: [] }),
        xrrpgIds.length ? sb.from('xrrpg_characters').select('id, name, base_stats').in('id', xrrpgIds) : Promise.resolve({ data: [] })
      ]);
      const webrunningById = Object.fromEntries(webrunningChars.map(char => [char.id, char]));
      const xrrpgById = Object.fromEntries(xrrpgChars.map(char => [char.id, char]));

      characterList.innerHTML = assignments.map(row => {
        const char = row.character_system === 'xrrpg' ? xrrpgById[row.xrrpg_character_id] : webrunningById[row.webrunning_character_id];
        const id = assignmentCharacterId(row);
        const link = row.character_system === 'xrrpg'
          ? `/xrrpg-2.0/xrrpg-character.html?id=${id}&campaign_id=${campaignId}&readonly=1`
          : `/webrunning-2.0/webrunning-character.html?id=${id}&campaign_id=${campaignId}&readonly=1`;
        const statBlurb = row.character_system === 'xrrpg' ? `<div class="muted">${xrrpgStatBlurb(char?.base_stats || {})}</div>` : '';
        return `<article class="assigned-character-card"><div class="assigned-character-header"><a class="assigned-character-name" href="${link}">${char?.name || 'Unnamed character'}</a><span class="assigned-character-role muted">${row.character_system.toUpperCase()}</span></div>${statBlurb}</article>`;
      }).join('');
    }

    async function loadPlayerCharacterOptions(campaignId, system) {
      const characterTable = system === 'xrrpg' ? 'xrrpg_characters' : 'webrunning_characters';
      const characterIdColumn = system === 'xrrpg' ? 'xrrpg_character_id' : 'webrunning_character_id';
      const [{ data: chars, error: charsError }, { data: assignment, error: assignmentError }] = await Promise.all([
        sb.from(characterTable).select("id, name, base_stats").eq("user_id", currentUser.id).order("created_at", { ascending: true }),
        sb.from("campaign_character_assignments")
          .select(`id, ${characterIdColumn}`)
          .eq("campaign_id", campaignId)
          .eq("user_id", currentUser.id)
          .eq("character_system", system)
          .maybeSingle()
      ]);

      if (charsError || assignmentError) {
        playerCharacterStatus.textContent = `Failed to load your characters.`;
        return;
      }

      playerCharacters = chars || [];
      playerCharacterSelect.innerHTML = "<option value=''>-- No character selected --</option>";
      playerCharacters.forEach(character => {
        const option = document.createElement("option");
        option.value = character.id;
        option.textContent = `${character.name || "Unnamed character"} (Lv ${character.base_stats?.level || 1})`;
        playerCharacterSelect.appendChild(option);
      });

      playerCharacterSelect.value = assignment?.[characterIdColumn] || "";
      if (!playerCharacters.length) {
        playerCharacterStatus.textContent = `You have no ${system.toUpperCase()} characters yet.`;
      } else {
        playerCharacterStatus.textContent = assignment ? "Your current campaign character is selected below." : "No campaign character selected yet.";
      }
    }

    invitePlayerBtn.onclick = async () => {
      const campaignId = selectedGameId();
      const inviteeId = inviteFriendSelect.value;
      const system = selectedCampaignSystem();
      if (!campaignId || !inviteeId) {
        gameStatus.textContent = "Pick a game and select a friend to invite.";
        return;
      }

      const { error: inviteError } = await sb.from("campaign_invites").insert({
        campaign_id: campaignId,
        inviter_user_id: currentUser.id,
        invitee_user_id: inviteeId,
        status: "pending",
        required_character_system: system
      });

      if (inviteError) {
        gameStatus.textContent = `Failed to invite: ${inviteError.message}`;
        return;
      }
      gameStatus.textContent = `Sent ${system.toUpperCase()} campaign invite.`;
      inviteFriendSelect.value = "";
    };

    createCampaignBtn.onclick = async () => {
      const name = newCampaignName.value.trim();
      const system = newCampaignSystem.value;
      if (!name) {
        gameStatus.textContent = "Enter a campaign name first.";
        return;
      }

      const { data: insertedCampaign, error: campaignError } = await sb.from("campaigns")
        .insert({ name, gm_user_id: currentUser.id, status: "active", system })
        .select("id, name")
        .single();

      if (campaignError || !insertedCampaign) {
        gameStatus.textContent = `Failed to create campaign: ${campaignError?.message || "Unknown error"}`;
        return;
      }

      const { error: gmMembershipError } = await sb.from("campaign_members").insert({
        campaign_id: insertedCampaign.id,
        user_id: currentUser.id,
        role: "gm"
      });
      if (gmMembershipError) {
        gameStatus.textContent = `Campaign created, but failed to register you as GM: ${gmMembershipError.message}`;
        return;
      }

      gameStatus.textContent = `Campaign "${insertedCampaign.name}" created.`;
      newCampaignName.value = "";
      await loadGames();
      gameSelect.value = insertedCampaign.id;
      await loadGameDetails();
    };

    savePlayerCharacterBtn.onclick = async () => {
      const campaignId = selectedGameId();
      const system = selectedCampaignSystem();
      if (!campaignId) {
        playerCharacterStatus.textContent = "Select a campaign first.";
        return;
      }

      const selectedCharacterId = playerCharacterSelect.value || null;

      await sb.from("campaign_character_assignments")
        .delete()
        .eq("campaign_id", campaignId)
        .eq("user_id", currentUser.id);

      if (!selectedCharacterId) {
        playerCharacterStatus.textContent = "Cleared your character selection for this campaign.";
        await loadGameDetails();
        return;
      }

      const payload = {
        campaign_id: campaignId,
        user_id: currentUser.id,
        character_system: system,
        webrunning_character_id: system === 'webrunning' ? selectedCharacterId : null,
        xrrpg_character_id: system === 'xrrpg' ? selectedCharacterId : null
      };
      const { error: insertError } = await sb.from("campaign_character_assignments").insert(payload);
      if (insertError) {
        playerCharacterStatus.textContent = `Failed to save character selection: ${insertError.message}`;
        return;
      }

      const selectedCharacter = playerCharacters.find(character => String(character.id) === String(selectedCharacterId));
      playerCharacterStatus.textContent = `Selected ${selectedCharacter?.name || "your character"} for this campaign.`;
      await loadGameDetails();
    };

    gameSelect.addEventListener("change", loadGameDetails);

    (async function initializePage() {
      await loadGames();
      await loadFriendInviteOptions();
    })();
  </script>
</body>
</html>
