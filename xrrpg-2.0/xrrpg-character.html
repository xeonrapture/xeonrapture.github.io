<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XRRPG Character Sheet</title>
  <link rel="stylesheet" href="/shared/style.css">
</head>
<body class="wr-scope">
  <div id="nav"></div>
  <main class="wrap sheet">
    <a class="action-btn" href="/xrrpg-2.0/xrrpg-character-manager.html">← Back to XRRPG Character Manager</a>
    <h1>XRRPG Character Sheet</h1>

    <section class="card">
      <h2>Character</h2>
      <div class="sheet-actions">
        <label>Name <input id="nameInput" maxlength="48" /></label>
        <label>Species <input id="speciesInput" maxlength="48" /></label>
        <label>Chroma <input id="chromaInput" maxlength="16" /></label>
        <button id="saveBtn" type="button">Save</button>
      </div>
    </section>

    <section class="card">
      <h2>Core Stats</h2>
      <div class="stat-inputs">
        <label>Level <input id="levelInput" type="number" min="1" max="9" /></label>
        <label>HP <input id="hpInput" type="number" /></label>
        <label>Current HP <input id="currentHpInput" type="number" /></label>
        <label>Vigor <input id="vigorInput" type="number" /></label>
        <label>Endurance <input id="enduranceInput" type="number" /></label>
        <label>Intuition <input id="intuitionInput" type="number" /></label>
        <label>Wit <input id="witInput" type="number" /></label>
        <label>Mastery Die <input id="masteryDieInput" /></label>
      </div>
      <button id="levelUpBtn" type="button">Level Up (Class/Tier)</button>
      <div id="status" class="mono muted"></div>
    </section>

    <section class="card">
      <h2>Class Progression</h2>
      <div id="classList" class="mono muted"></div>
    </section>

    <section class="card">
      <h2>History</h2>
      <table class="table-full">
        <thead>
          <tr>
            <th><button type="button" class="table-sort" data-sort="created_at">Date</button></th>
            <th><button type="button" class="table-sort" data-sort="event_type">Type</button></th>
            <th><button type="button" class="table-sort" data-sort="event_label">Event</button></th>
          </tr>
        </thead>
        <tbody id="historyTable"><tr><td colspan="3">Loading…</td></tr></tbody>
      </table>
    </section>
  </main>

  <div id="levelModal" class="xr-modal hidden">
    <div class="xr-modal-backdrop"></div>
    <div class="xr-modal-card">
      <h2>Level Up</h2>
      <p class="muted">Pick a class level. Existing class levels advance to new tier (I → II → III).</p>
      <label>Class
        <select id="levelClassSelect"></select>
      </label>
      <div class="xr-modal-actions">
        <button id="confirmLevelBtn" type="button">Apply</button>
        <button id="cancelLevelBtn" type="button">Cancel</button>
      </div>
      <div id="levelMsg" class="mono muted"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/shared/auth.js"></script>
  <script src="/shared/nav.js"></script>
  <script>
    const sb = window.supabaseClient;
    const params = new URLSearchParams(window.location.search);
    const characterId = params.get('id');
    const classNames = [
      'Warrior','Mentalist','Tank','Druid','Elementalist','Summoner','Mystic','Alchemist','Physic','Possessor','Bard','Enchanter','Sorcerer','Warlock','Cleric','Demititan','Emitter Specialist','Dronemaster','Brawler','Explosives Expert','Gunslinger','Swordmaster'
    ];
    const historyTable = document.getElementById('historyTable');
    let currentUser = null;
    let character = null;
    let history = [];
    let historySort = { key: 'created_at', direction: 'desc' };

    classNames.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      document.getElementById('levelClassSelect').appendChild(opt);
    });

    async function requireUser() {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) throw new Error('No user');
      return user;
    }

    function toMasteryDie(level) {
      if (level >= 9) return 'd12';
      if (level >= 7) return 'd10';
      if (level >= 5) return 'd8';
      if (level >= 3) return 'd6';
      return 'd4';
    }

    function readStatsFromInputs() {
      return {
        ...character.base_stats,
        species: document.getElementById('speciesInput').value.trim(),
        chroma: document.getElementById('chromaInput').value.trim(),
        level: Number(document.getElementById('levelInput').value) || 1,
        hp: Number(document.getElementById('hpInput').value) || 0,
        current_hp: Number(document.getElementById('currentHpInput').value) || 0,
        vigor: Number(document.getElementById('vigorInput').value) || 0,
        endurance: Number(document.getElementById('enduranceInput').value) || 0,
        intuition: Number(document.getElementById('intuitionInput').value) || 0,
        wit: Number(document.getElementById('witInput').value) || 0,
        mastery_die: document.getElementById('masteryDieInput').value.trim() || 'd4'
      };
    }

    function renderCharacter() {
      const s = character.base_stats || {};
      document.getElementById('nameInput').value = character.name || '';
      document.getElementById('speciesInput').value = s.species || '';
      document.getElementById('chromaInput').value = s.chroma || '';
      document.getElementById('levelInput').value = s.level || 1;
      document.getElementById('hpInput').value = s.hp || 0;
      document.getElementById('currentHpInput').value = s.current_hp ?? s.hp ?? 0;
      document.getElementById('vigorInput').value = s.vigor || 0;
      document.getElementById('enduranceInput').value = s.endurance || 0;
      document.getElementById('intuitionInput').value = s.intuition || 0;
      document.getElementById('witInput').value = s.wit || 0;
      document.getElementById('masteryDieInput').value = s.mastery_die || 'd4';

      document.getElementById('classList').innerHTML = (character.class_progression || []).length
        ? character.class_progression.map(row => `• Lv ${row.level_acquired}: ${row.class} (Tier ${row.tier})`).join('<br>')
        : 'No classes selected yet.';
    }

    function renderHistory() {
      if (!history.length) {
        historyTable.innerHTML = '<tr><td colspan="3">No history yet.</td></tr>';
        return;
      }
      const dir = historySort.direction === 'asc' ? 1 : -1;
      const sorted = [...history].sort((a,b) => {
        const av = String(a[historySort.key] ?? '');
        const bv = String(b[historySort.key] ?? '');
        if (av < bv) return -1 * dir;
        if (av > bv) return 1 * dir;
        return 0;
      });
      historyTable.innerHTML = sorted.map(row => `
        <tr>
          <td>${new Date(row.created_at).toLocaleString()}</td>
          <td>${row.event_type}</td>
          <td>${row.event_label}</td>
        </tr>
      `).join('');
    }

    async function loadCharacter() {
      currentUser = await requireUser();
      const { data, error } = await sb.from('xrrpg_characters')
        .select('id, user_id, name, base_stats, class_progression')
        .eq('id', characterId)
        .single();
      if (error) throw error;
      character = data;
      renderCharacter();
    }

    async function loadHistory() {
      const { data, error } = await sb.from('xrrpg_history')
        .select('id, event_type, event_label, created_at')
        .eq('character_id', characterId)
        .order('created_at', { ascending: false });
      if (error) throw error;
      history = data || [];
      renderHistory();
    }

    async function addHistory(eventType, eventLabel, eventPayload = {}) {
      await sb.from('xrrpg_history').insert({
        character_id: characterId,
        user_id: currentUser.id,
        event_type: eventType,
        event_label: eventLabel,
        event_payload: eventPayload
      });
      await loadHistory();
    }

    document.getElementById('saveBtn').onclick = async () => {
      const name = document.getElementById('nameInput').value.trim();
      const base_stats = readStatsFromInputs();
      const { error } = await sb.from('xrrpg_characters')
        .update({ name, base_stats, updated_at: new Date().toISOString() })
        .eq('id', characterId)
        .eq('user_id', currentUser.id);
      if (error) {
        document.getElementById('status').textContent = error.message;
        return;
      }
      await addHistory('edit', `Saved character ${name}.`, { level: base_stats.level });
      document.getElementById('status').textContent = 'Saved.';
      await loadCharacter();
    };

    const levelModal = document.getElementById('levelModal');
    document.getElementById('levelUpBtn').onclick = () => levelModal.classList.remove('hidden');
    levelModal.querySelector('.xr-modal-backdrop').onclick = () => levelModal.classList.add('hidden');
    document.getElementById('cancelLevelBtn').onclick = () => levelModal.classList.add('hidden');

    document.getElementById('confirmLevelBtn').onclick = async () => {
      const cls = document.getElementById('levelClassSelect').value;
      const progression = [...(character.class_progression || [])];
      const currentLevel = Number(character.base_stats?.level || 1);
      const level = Math.min(9, currentLevel + 1);
      const entryCount = progression.filter(item => item.class === cls).length;
      const tier = Math.min(3, entryCount + 1);
      progression.push({ class: cls, tier, level_acquired: level });

      const base_stats = { ...character.base_stats, level, mastery_die: toMasteryDie(level) };
      const { error } = await sb.from('xrrpg_characters')
        .update({ class_progression: progression, base_stats, updated_at: new Date().toISOString() })
        .eq('id', characterId)
        .eq('user_id', currentUser.id);
      if (error) {
        document.getElementById('levelMsg').textContent = error.message;
        return;
      }

      await addHistory('level_up', `Level ${level}: ${cls} advanced to Tier ${tier}.`, { class: cls, tier, level });
      levelModal.classList.add('hidden');
      await loadCharacter();
      document.getElementById('status').textContent = `Level up applied: ${cls} Tier ${tier}.`;
    };

    document.querySelectorAll('.table-sort').forEach(button => {
      button.onclick = () => {
        const key = button.dataset.sort;
        if (historySort.key === key) {
          historySort.direction = historySort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          historySort = { key, direction: 'asc' };
        }
        renderHistory();
      };
    });

    (async () => {
      try {
        await loadCharacter();
        await loadHistory();
      } catch (error) {
        document.getElementById('status').textContent = error.message;
      }
    })();
  </script>
</body>
</html>
