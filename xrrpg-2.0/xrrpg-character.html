<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XRRPG Character Sheet</title>
  <link rel="stylesheet" href="/shared/style.css">
</head>
<body class="wr-scope">
  <div id="nav"></div>
  <main class="wrap sheet">
    <header>
      <div style="display:flex; align-items:center; gap:0.5rem; justify-content:space-between; flex-wrap:wrap;">
        <a class="action-btn" href="/xrrpg-2.0/xrrpg-character-manager.html" aria-label="Back to XRRPG character manager">
          <span aria-hidden="true">←</span>
          <span>Back to XRRPG Character Manager</span>
        </a>
      </div>
      <h1>XRRPG Character Sheet</h1>
    </header>

    <section class="card">
      <h2>Character</h2>
      <div class="sheet-actions">
        <label>Name <input id="nameInput" maxlength="48" /></label>
        <label>Species <input id="speciesInput" maxlength="48" /></label>
        <label>Chroma <input id="chromaInput" maxlength="16" /></label>
        <button id="saveBtn" type="button">Save</button>
      </div>
    </section>

    <section class="card">
      <h2>Core Stats</h2>
      <div class="xrrpg-stat-line">
        <label title="Character level from 1 to 9.">Level <input id="levelInput" type="number" min="1" max="9" /></label>
        <label title="Mastery die used for class actions.">Mastery Die <input id="masteryDieInput" /></label>
      </div>
      <div class="xrrpg-stat-line xrrpg-stat-column">
        <label title="Vigor supports movement, power, and will.">Vigor <input id="vigorInput" type="number" /></label>
        <label title="Endurance supports resilience and toughness.">Endurance <input id="enduranceInput" type="number" /></label>
        <label title="Intuition supports dexterity, perception, and charisma.">Intuition <input id="intuitionInput" type="number" /></label>
        <label title="Wit supports logic, innovation, and memory.">Wit <input id="witInput" type="number" /></label>
      </div>
      <div class="xrrpg-row" style="margin-top:0.8rem;">
        <button id="levelUpBtn" type="button">Level Up (Class/Tier)</button>
        <button id="takeInjuryBtn" type="button">Take Injury</button>
      </div>
      <div id="status" class="mono muted"></div>
    </section>

    <section class="card">
      <h2>Health & Injuries</h2>
      <div class="stat-inputs">
        <label title="Maximum HP from your build and progression.">Max HP <input id="hpInput" type="number" /></label>
        <label title="Current HP after damage/healing.">Current HP <input id="currentHpInput" type="number" /></label>
      </div>
      <div id="injuryTracker" class="xrrpg-injury-tracker"></div>
    </section>

    <section class="card">
      <h2>Resource Tracking</h2>
      <div class="stat-inputs">
        <label title="Total stamina available for class abilities.">Total Stamina <input id="staminaTotalInput" type="number" min="0" /></label>
        <label title="How much stamina has been used.">Stamina Used <input id="staminaUsedInput" type="number" min="0" /></label>
        <label title="Stamina exhaustion threshold before forced checks.">Stamina Exhaustion Limit <input id="staminaLimitInput" type="number" min="0" /></label>
        <label title="Max number of powerful items you can actively use.">Powerful Item Limit <input id="powerfulItemLimitInput" type="number" min="0" /></label>
        <label title="Absolute cap for powerful item upgrades.">Powerful Item Max <input id="powerfulItemMaxInput" type="number" min="0" /></label>
        <label title="Party progression tier used for group actions.">Party Tier <input id="partyTierInput" type="number" min="1" /></label>
        <label title="Current xenic decay level.">Xenic Decay Level <input id="xenicDecayInput" type="number" min="0" /></label>
        <label title="Total number of decay cleanses.">Times Cleansed <input id="timesCleansedInput" type="number" min="0" /></label>
      </div>
    </section>

    <section class="card">
      <h2>Skills</h2>
      <div id="skillList" class="mono muted">No skills saved.</div>
    </section>

    <section class="card">
      <h2>Class Progression</h2>
      <div id="classList" class="mono muted"></div>
      <h3 style="margin-top:1rem;">Class Abilities</h3>
      <div id="classAbilityList" class="ability-list"></div>
    </section>

    <section class="card">
      <h2>Character Notes</h2>
      <div class="xrrpg-notes-stack">
        <label>Appearance<textarea id="appearanceInput"></textarea></label>
        <label>Personality<textarea id="personalityInput"></textarea></label>
        <label>Motivation<textarea id="motivationInput"></textarea></label>
        <label>BACKSTORY<textarea id="backstoryInput"></textarea></label>
        <label>Extra Notes<textarea id="extraNotesInput"></textarea></label>
      </div>
    </section>

    <section class="card">
      <h2>History</h2>
      <table class="table-full">
        <thead>
          <tr>
            <th><button type="button" class="table-sort" data-sort="created_at">Date</button></th>
            <th><button type="button" class="table-sort" data-sort="event_type">Type</button></th>
            <th><button type="button" class="table-sort" data-sort="event_label">Event</button></th>
          </tr>
        </thead>
        <tbody id="historyTable"><tr><td colspan="3">Loading…</td></tr></tbody>
      </table>
    </section>
  </main>

  <div id="levelModal" class="xr-modal hidden">
    <div class="xr-modal-backdrop"></div>
    <div class="xr-modal-card">
      <h2>Level Up</h2>
      <p class="muted">Pick a class level. Existing class levels advance to new tier (I → II → III).</p>
      <label>Class
        <select id="levelClassSelect"></select>
      </label>
      <label>Ability choices for this level
        <textarea id="levelAbilityInput" placeholder="Add the abilities you took (one per line or comma-separated)"></textarea>
      </label>
      <p class="muted">Class abilities reference files live in <code>XRRPG-2.0-reference/Classes/</code>. Add the abilities you choose here when leveling.</p>
      <div class="xr-modal-actions">
        <button id="confirmLevelBtn" type="button">Apply</button>
        <button id="cancelLevelBtn" type="button">Cancel</button>
      </div>
      <div id="levelMsg" class="mono muted"></div>
    </div>
  </div>

  <div id="injuryModal" class="xr-modal hidden">
    <div class="xr-modal-backdrop"></div>
    <div class="xr-modal-card">
      <h2>Take Injury</h2>
      <p class="muted">Minor: 1 DMG + next Action -2. Severe: 2 DMG + lose 1 Stamina. Critical: 3 DMG + -1 all Actions until healed.</p>
      <div class="stat-inputs">
        <label>Injury type
          <select id="injuryTypeInput">
            <option value="minor">Minor</option>
            <option value="severe">Severe</option>
            <option value="critical">Critical</option>
          </select>
        </label>
        <label>Injury label
          <input id="injuryLabelInput" maxlength="64" placeholder="Bruised / Lacerated / Bleeding Out" />
        </label>
      </div>
      <div class="xr-modal-actions">
        <button id="confirmInjuryBtn" type="button">Apply Injury</button>
        <button id="cancelInjuryBtn" type="button">Cancel</button>
      </div>
      <div id="injuryMsg" class="mono muted"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="/shared/auth.js"></script>
  <script src="/shared/nav.js"></script>
  <script>
    const sb = window.supabaseClient;
    const params = new URLSearchParams(window.location.search);
    const characterId = params.get('id');
    const classNames = [
      'Warrior','Mentalist','Tank','Druid','Elementalist','Summoner','Mystic','Alchemist','Physic','Possessor','Bard','Enchanter','Sorcerer','Warlock','Cleric','Demititan','Emitter Specialist','Dronemaster','Brawler','Explosives Expert','Gunslinger','Swordmaster'
    ];
    const historyTable = document.getElementById('historyTable');
    let currentUser = null;
    let character = null;
    let history = [];
    let historySort = { key: 'created_at', direction: 'desc' };

    classNames.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      document.getElementById('levelClassSelect').appendChild(opt);
    });

    async function requireUser() {
      const { data: { user } } = await sb.auth.getUser();
      if (!user) throw new Error('No user');
      return user;
    }

    function toMasteryDie(level) {
      if (level >= 9) return 'd12';
      if (level >= 7) return 'd10';
      if (level >= 5) return 'd8';
      if (level >= 3) return 'd6';
      return 'd4';
    }

    function parseNotes() {
      if (!character?.notes) return {};
      try {
        return JSON.parse(character.notes);
      } catch (_error) {
        return { extra: character.notes };
      }
    }

    function readNotesFromInputs() {
      return JSON.stringify({
        appearance: document.getElementById('appearanceInput').value.trim(),
        personality: document.getElementById('personalityInput').value.trim(),
        motivation: document.getElementById('motivationInput').value.trim(),
        backstory: document.getElementById('backstoryInput').value.trim(),
        extra: document.getElementById('extraNotesInput').value.trim()
      });
    }

    function readClassAbilities() {
      const abilities = {};
      document.querySelectorAll('[data-ability-key]').forEach(textarea => {
        abilities[textarea.dataset.abilityKey] = textarea.value.trim();
      });
      return abilities;
    }

    function readStatsFromInputs() {
      return {
        ...character.base_stats,
        species: document.getElementById('speciesInput').value.trim(),
        chroma: document.getElementById('chromaInput').value.trim(),
        level: Number(document.getElementById('levelInput').value) || 1,
        hp: Number(document.getElementById('hpInput').value) || 0,
        current_hp: Number(document.getElementById('currentHpInput').value) || 0,
        vigor: Number(document.getElementById('vigorInput').value) || 0,
        endurance: Number(document.getElementById('enduranceInput').value) || 0,
        intuition: Number(document.getElementById('intuitionInput').value) || 0,
        wit: Number(document.getElementById('witInput').value) || 0,
        mastery_die: document.getElementById('masteryDieInput').value.trim() || 'd4',
        stamina_total: Number(document.getElementById('staminaTotalInput').value) || 0,
        stamina_used: Number(document.getElementById('staminaUsedInput').value) || 0,
        stamina_exhaustion_limit: Number(document.getElementById('staminaLimitInput').value) || 0,
        powerful_item_limit: Number(document.getElementById('powerfulItemLimitInput').value) || 0,
        powerful_item_max: Number(document.getElementById('powerfulItemMaxInput').value) || 0,
        party_tier: Number(document.getElementById('partyTierInput').value) || 1,
        xenic_decay_level: Number(document.getElementById('xenicDecayInput').value) || 0,
        times_cleansed: Number(document.getElementById('timesCleansedInput').value) || 0,
        class_abilities: readClassAbilities()
      };
    }

    function injurySummary(injuries) {
      return {
        minor: injuries.filter(injury => injury.type === 'minor'),
        severe: injuries.filter(injury => injury.type === 'severe'),
        critical: injuries.filter(injury => injury.type === 'critical')
      };
    }

    function normalizeAbilityChoices(raw) {
      return raw
        .split(/\n|,/)
        .map(item => item.trim())
        .filter(Boolean);
    }

    function renderInjuryTracker() {
      const injuries = Array.isArray(character?.base_stats?.injuries) ? character.base_stats.injuries : [];
      const grouped = injurySummary(injuries);
      const wrap = document.getElementById('injuryTracker');
      wrap.innerHTML = ['minor', 'severe', 'critical'].map(type => {
        const rows = grouped[type].length
          ? grouped[type].map((injury, idx) => `<div class="xrrpg-injury-item">${injury.label || 'Unnamed injury'} <button type="button" data-heal-type="${type}" data-heal-index="${idx}">Heal</button></div>`).join('')
          : '<div class="muted">None</div>';
        return `<div class="xrrpg-injury-group"><h3>${type[0].toUpperCase() + type.slice(1)}</h3>${rows}</div>`;
      }).join('');

      wrap.querySelectorAll('[data-heal-type]').forEach(button => {
        button.onclick = () => healInjury(button.dataset.healType, Number(button.dataset.healIndex));
      });
    }

    function renderCharacter() {
      const s = character.base_stats || {};
      const notes = parseNotes();
      document.getElementById('nameInput').value = character.name || '';
      document.getElementById('speciesInput').value = s.species || '';
      document.getElementById('chromaInput').value = s.chroma || '';
      document.getElementById('levelInput').value = s.level || 1;
      document.getElementById('hpInput').value = s.hp || 0;
      document.getElementById('currentHpInput').value = s.current_hp ?? s.hp ?? 0;
      document.getElementById('vigorInput').value = s.vigor || 0;
      document.getElementById('enduranceInput').value = s.endurance || 0;
      document.getElementById('intuitionInput').value = s.intuition || 0;
      document.getElementById('witInput').value = s.wit || 0;
      document.getElementById('masteryDieInput').value = s.mastery_die || 'd4';
      document.getElementById('staminaTotalInput').value = s.stamina_total ?? (10 + (s.intuition || 0) + (s.wit || 0));
      document.getElementById('staminaUsedInput').value = s.stamina_used || 0;
      document.getElementById('staminaLimitInput').value = s.stamina_exhaustion_limit ?? (s.stamina_total || 0);
      document.getElementById('powerfulItemLimitInput').value = s.powerful_item_limit || 0;
      document.getElementById('powerfulItemMaxInput').value = s.powerful_item_max || 0;
      document.getElementById('partyTierInput').value = s.party_tier || 1;
      document.getElementById('xenicDecayInput').value = s.xenic_decay_level || 0;
      document.getElementById('timesCleansedInput').value = s.times_cleansed || 0;

      document.getElementById('appearanceInput').value = notes.appearance || '';
      document.getElementById('personalityInput').value = notes.personality || '';
      document.getElementById('motivationInput').value = notes.motivation || '';
      document.getElementById('backstoryInput').value = notes.backstory || '';
      document.getElementById('extraNotesInput').value = notes.extra || '';

      document.getElementById('classList').innerHTML = (character.class_progression || []).length
        ? character.class_progression.map(row => `• Lv ${row.level_acquired}: ${row.class} (Tier ${row.tier})`).join('<br>')
        : 'No classes selected yet.';

      renderInjuryTracker();

      const abilities = s.class_abilities || {};
      const chosenAbilities = s.class_ability_choices || {};
      const abilityWrap = document.getElementById('classAbilityList');
      if (!(character.class_progression || []).length) {
        abilityWrap.innerHTML = '<div class="muted">No class abilities yet.</div>';
      } else {
        abilityWrap.innerHTML = character.class_progression.map((entry, idx) => {
          const key = `${entry.class}-T${entry.tier}-L${entry.level_acquired}-${idx}`;
          const chosen = Array.isArray(chosenAbilities[key]) && chosenAbilities[key].length
            ? `<div class="muted">Chosen on level up: ${chosenAbilities[key].join(', ')}</div>`
            : '<div class="muted">Chosen on level up: none recorded</div>';
          return `<label>${entry.class} Tier ${entry.tier} Abilities<textarea data-ability-key="${key}" placeholder="List abilities from the core rules for this class tier...">${abilities[key] || ''}</textarea>${chosen}</label>`;
        }).join('');
      }

      const skills = character.skills || [];
      document.getElementById('skillList').innerHTML = skills.length
        ? skills.map(skill => `• ${skill.name || 'Unnamed skill'} (+${Number(skill.bonus || 0)})`).join('<br>')
        : 'No skills saved.';
    }

    function renderHistory() {
      if (!history.length) {
        historyTable.innerHTML = '<tr><td colspan="3">No history yet.</td></tr>';
        return;
      }
      const dir = historySort.direction === 'asc' ? 1 : -1;
      const sorted = [...history].sort((a,b) => {
        const av = String(a[historySort.key] ?? '');
        const bv = String(b[historySort.key] ?? '');
        if (av < bv) return -1 * dir;
        if (av > bv) return 1 * dir;
        return 0;
      });
      historyTable.innerHTML = sorted.map(row => `
        <tr>
          <td>${new Date(row.created_at).toLocaleString()}</td>
          <td>${row.event_type}</td>
          <td>${row.event_label}</td>
        </tr>
      `).join('');
    }

    async function loadCharacter() {
      currentUser = await requireUser();
      const { data, error } = await sb.from('xrrpg_characters')
        .select('id, user_id, name, base_stats, class_progression, skills, notes')
        .eq('id', characterId)
        .single();
      if (error) throw error;
      character = data;
      renderCharacter();
    }

    async function loadHistory() {
      const { data, error } = await sb.from('xrrpg_history')
        .select('id, event_type, event_label, created_at')
        .eq('character_id', characterId)
        .order('created_at', { ascending: false });
      if (error) throw error;
      history = data || [];
      renderHistory();
    }

    async function addHistory(eventType, eventLabel, eventPayload = {}) {
      await sb.from('xrrpg_history').insert({
        character_id: characterId,
        user_id: currentUser.id,
        event_type: eventType,
        event_label: eventLabel,
        event_payload: eventPayload
      });
      await loadHistory();
    }

    document.getElementById('saveBtn').onclick = async () => {
      const name = document.getElementById('nameInput').value.trim();
      const base_stats = readStatsFromInputs();
      const notes = readNotesFromInputs();
      const { error } = await sb.from('xrrpg_characters')
        .update({ name, notes, base_stats, updated_at: new Date().toISOString() })
        .eq('id', characterId)
        .eq('user_id', currentUser.id);
      if (error) {
        document.getElementById('status').textContent = error.message;
        return;
      }
      await addHistory('edit', `Saved character ${name}.`, { level: base_stats.level });
      document.getElementById('status').textContent = 'Saved.';
      await loadCharacter();
    };

    const levelModal = document.getElementById('levelModal');
    document.getElementById('levelUpBtn').onclick = () => levelModal.classList.remove('hidden');
    levelModal.querySelector('.xr-modal-backdrop').onclick = () => levelModal.classList.add('hidden');
    document.getElementById('cancelLevelBtn').onclick = () => levelModal.classList.add('hidden');

    document.getElementById('confirmLevelBtn').onclick = async () => {
      const cls = document.getElementById('levelClassSelect').value;
      const progression = [...(character.class_progression || [])];
      const currentLevel = Number(character.base_stats?.level || 1);
      const level = Math.min(9, currentLevel + 1);
      const entryCount = progression.filter(item => item.class === cls).length;
      const tier = Math.min(3, entryCount + 1);
      progression.push({ class: cls, tier, level_acquired: level });
      const choices = normalizeAbilityChoices(document.getElementById('levelAbilityInput').value.trim());
      const key = `${cls}-T${tier}-L${level}-${progression.length - 1}`;

      const base_stats = {
        ...character.base_stats,
        level,
        mastery_die: toMasteryDie(level),
        class_ability_choices: {
          ...(character.base_stats?.class_ability_choices || {}),
          [key]: choices
        }
      };
      const { error } = await sb.from('xrrpg_characters')
        .update({ class_progression: progression, base_stats, updated_at: new Date().toISOString() })
        .eq('id', characterId)
        .eq('user_id', currentUser.id);
      if (error) {
        document.getElementById('levelMsg').textContent = error.message;
        return;
      }

      await addHistory('level_up', `Level ${level}: ${cls} advanced to Tier ${tier}.`, { class: cls, tier, level });
      levelModal.classList.add('hidden');
      document.getElementById('levelAbilityInput').value = '';
      await loadCharacter();
      document.getElementById('status').textContent = `Level up applied: ${cls} Tier ${tier}.`;
    };

    async function healInjury(type, index) {
      const base_stats = { ...(character.base_stats || {}) };
      const injuries = Array.isArray(base_stats.injuries) ? [...base_stats.injuries] : [];
      const matchingIndexes = injuries
        .map((injury, injuryIndex) => ({ injury, injuryIndex }))
        .filter(row => row.injury.type === type);
      const target = matchingIndexes[index];
      if (!target) return;
      const [removed] = injuries.splice(target.injuryIndex, 1);
      base_stats.injuries = injuries;

      const { error } = await sb.from('xrrpg_characters')
        .update({ base_stats, updated_at: new Date().toISOString() })
        .eq('id', characterId)
        .eq('user_id', currentUser.id);
      if (error) {
        document.getElementById('status').textContent = error.message;
        return;
      }
      await addHistory('heal_injury', `Healed ${type} injury: ${removed.label || 'unnamed'}.`, { type, label: removed.label || '' });
      await loadCharacter();
      document.getElementById('status').textContent = `Healed ${type} injury.`;
    }

    const injuryModal = document.getElementById('injuryModal');
    document.getElementById('takeInjuryBtn').onclick = () => injuryModal.classList.remove('hidden');
    injuryModal.querySelector('.xr-modal-backdrop').onclick = () => injuryModal.classList.add('hidden');
    document.getElementById('cancelInjuryBtn').onclick = () => injuryModal.classList.add('hidden');

    document.getElementById('confirmInjuryBtn').onclick = async () => {
      const type = document.getElementById('injuryTypeInput').value;
      const label = document.getElementById('injuryLabelInput').value.trim();
      const damageByType = { minor: 1, severe: 2, critical: 3 };
      const damage = damageByType[type] || 1;
      const base_stats = { ...(character.base_stats || {}) };
      const currentHp = Number(base_stats.current_hp ?? base_stats.hp ?? 0);
      base_stats.current_hp = Math.max(0, currentHp - damage);
      if (!Array.isArray(base_stats.injuries)) base_stats.injuries = [];
      base_stats.injuries.push({ type, label, damage, at: new Date().toISOString() });

      if (type === 'severe') {
        base_stats.stamina_used = Number(base_stats.stamina_used || 0) + 1;
      }
      if (type === 'critical') {
        base_stats.critical_action_penalty = Number(base_stats.critical_action_penalty || 0) - 1;
      }

      const { error } = await sb.from('xrrpg_characters')
        .update({ base_stats, updated_at: new Date().toISOString() })
        .eq('id', characterId)
        .eq('user_id', currentUser.id);
      if (error) {
        document.getElementById('injuryMsg').textContent = error.message;
        return;
      }

      await addHistory('injury', `${type.toUpperCase()} injury: ${label || 'unnamed'} (${damage} dmg).`, { type, label, damage });
      injuryModal.classList.add('hidden');
      await loadCharacter();
      document.getElementById('status').textContent = `Applied ${type} injury (${damage} dmg).`;
    };

    document.querySelectorAll('.table-sort').forEach(button => {
      button.onclick = () => {
        const key = button.dataset.sort;
        if (historySort.key === key) {
          historySort.direction = historySort.direction === 'asc' ? 'desc' : 'asc';
        } else {
          historySort = { key, direction: 'asc' };
        }
        renderHistory();
      };
    });

    (async () => {
      try {
        await loadCharacter();
        await loadHistory();
      } catch (error) {
        document.getElementById('status').textContent = error.message;
      }
    })();
  </script>
</body>
</html>
